# GitHub Actions Workflow: Build and Publish Self-Contained Executables
# Triggers on every push and pull request to any branch
# Uploads binaries as downloadable artifacts

name: Build and Publish

on:
  push:
    branches:
      - '**'  # All branches
  pull_request:
    branches:
      - '**'  # All branches

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'  # Required for .NET 10 until GA release

      - name: Display .NET info
        run: dotnet --info

      - name: Restore dependencies
        run: dotnet restore source/HelloDotnetTen

      - name: Build solution
        run: dotnet build source/HelloDotnetTen --configuration Release --no-restore

      - name: Run publish script
        shell: pwsh
        run: ./publish.ps1

      - name: List published files
        run: |
          echo "Published files:"
          find publish -type f -executable -o -name "*.exe" 2>/dev/null | head -50
          echo ""
          echo "Directory structure:"
          ls -laR publish/ | head -100

      - name: Upload Windows x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-win-x64
          path: publish/HelloDotnetTen.Console/win-x64/
          if-no-files-found: warn

      - name: Upload Windows x86 artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-win-x86
          path: publish/HelloDotnetTen.Console/win-x86/
          if-no-files-found: warn

      - name: Upload Windows ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-win-arm64
          path: publish/HelloDotnetTen.Console/win-arm64/
          if-no-files-found: warn

      - name: Upload Linux x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-linux-x64
          path: publish/HelloDotnetTen.Console/linux-x64/
          if-no-files-found: warn

      - name: Upload Linux ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-linux-arm64
          path: publish/HelloDotnetTen.Console/linux-arm64/
          if-no-files-found: warn

      - name: Upload Linux ARM artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-linux-arm
          path: publish/HelloDotnetTen.Console/linux-arm/
          if-no-files-found: warn

      - name: Upload Linux musl x64 (Alpine) artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-linux-musl-x64
          path: publish/HelloDotnetTen.Console/linux-musl-x64/
          if-no-files-found: warn

      - name: Upload Linux musl ARM64 (Alpine) artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-linux-musl-arm64
          path: publish/HelloDotnetTen.Console/linux-musl-arm64/
          if-no-files-found: warn

      - name: Upload macOS x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-osx-x64
          path: publish/HelloDotnetTen.Console/osx-x64/
          if-no-files-found: warn

      - name: Upload macOS ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloDotnetTen-osx-arm64
          path: publish/HelloDotnetTen.Console/osx-arm64/
          if-no-files-found: warn

      - name: Upload publish manifest
        uses: actions/upload-artifact@v4
        with:
          name: publish-manifest
          path: publish/publish-manifest.json
          if-no-files-found: warn
